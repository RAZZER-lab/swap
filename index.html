<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YRS Staking Platform</title>
    
    <!-- Fixed CDN URLs with working versions -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Fixed Ethers.js CDN - using a more reliable source -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" integrity="sha384-3M2Tw9uCQ6hb0Zz8pZqcnpVZIzY5L+4qZQ0oMciTA0ZNY0B6PZOkcMVkIVdZ2O0I" crossorigin="anonymous"></script>
    
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: #3a5bd9;
            border-color: #3a5bd9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .wallet-address {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .ratio-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .token-balance {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.7rem;
            border: 1px solid #ddd;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 108, 247, 0.25);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
        }
        
        .loading-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .loading .loading-spinner {
            display: inline-block;
        }
        
        .loading .btn-text {
            display: none;
        }
        
        .tab-content {
            padding-top: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .stats-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        /* Additional styles for better error handling */
        .error-message {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .status-connected {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-currency-bitcoin"></i> YRS Staking Platform
            </a>
            <div class="d-flex align-items-center">
                <div id="connectionStatus" class="connection-status status-disconnected me-3 d-none">
                    <i class="bi bi-dot"></i> Disconnected
                </div>
                <div id="walletInfo" class="me-3 d-none">
                    <span class="wallet-address" id="walletAddress"></span>
                </div>
                <button id="connectWalletBtn" class="btn btn-primary">
                    <i class="bi bi-wallet2"></i> Connect Wallet
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-4">YRS Staking Platform</h1>
            <p class="lead">Stake your wZYS tokens and earn YRS with bonuses</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mb-5">
        <!-- Connection Requirements -->
        <div class="row mb-4" id="requirementsSection">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> Requirements
                    </div>
                    <div class="card-body">
                        <p>To use this dApp, you need:</p>
                        <ul>
                            <li>A Web3 wallet (like MetaMask) installed in your browser</li>
                            <li>Ensure you're on a supported network</li>
                            <li>Have some ETH for transaction fees</li>
                        </ul>
                        <div id="noWalletAlert" class="alert alert-warning d-none">
                            <i class="bi bi-exclamation-triangle"></i> No Web3 wallet detected. Please install MetaMask or another Ethereum wallet.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">wZYS Deposited</div>
                    <div class="stats-value" id="totalWZYS">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">YRS Reserve Shares</div>
                    <div class="stats-value" id="totalYRS">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">wZYS/YRS Ratio</div>
                    <div class="ratio-display" id="ratio">0</div>
                </div>
            </div>
        </div>

        <!-- User Balances Section -->
        <div class="row mb-4" id="userBalancesSection" style="display: none;">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-wallet2"></i> Your wZYS Balance
                    </div>
                    <div class="card-body">
                        <div class="token-balance" id="userWZYSBalance">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-wallet2"></i> Your YRS Balance
                    </div>
                    <div class="card-body">
                        <div class="token-balance" id="userYRSBalance">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buy/Sell Section -->
        <div class="row" id="tradeSection" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-arrow-left-right"></i> Trade Tokens
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="tradeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="buy-tab" data-bs-toggle="tab" data-bs-target="#buy" type="button" role="tab" aria-controls="buy" aria-selected="true">Buy YRS</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sell-tab" data-bs-toggle="tab" data-bs-target="#sell" type="button" role="tab" aria-controls="sell" aria-selected="false">Sell YRS</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="burn-tab" data-bs-toggle="tab" data-bs-target="#burn" type="button" role="tab" aria-controls="burn" aria-selected="false">Burn YRS</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="tradeTabContent">
                            <!-- Buy Tab -->
                            <div class="tab-pane fade show active" id="buy" role="tabpanel" aria-labelledby="buy-tab">
                                <form id="buyForm">
                                    <div class="mb-3">
                                        <label for="buyWZYSAmount" class="form-label">wZYS Amount</label>
                                        <input type="number" class="form-control" id="buyWZYSAmount" placeholder="Amount of wZYS to spend" min="0" step="0.0001" required>
                                        <div class="error-message" id="buyWZYSAmountError"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyMinYRSOut" class="form-label">Minimum YRS Expected (Slippage Protection)</label>
                                        <input type="number" class="form-control" id="buyMinYRSOut" placeholder="Minimum YRS you expect to receive" min="0" step="0.0001" required>
                                        <div class="error-message" id="buyMinYRSError"></div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> You will receive a 10% bonus on your purchase.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <span class="btn-text">Buy YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                </form>
                            </div>
                            <!-- Sell Tab -->
                            <div class="tab-pane fade" id="sell" role="tabpanel" aria-labelledby="sell-tab">
                                <form id="sellForm">
                                    <div class="mb-3">
                                        <label for="sellYRSAmount" class="form-label">YRS Amount</label>
                                        <input type="number" class="form-control" id="sellYRSAmount" placeholder="Amount of YRS to sell" min="0" step="0.0001" required>
                                        <div class="error-message" id="sellYRSAmountError"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sellMinWZYSOut" class="form-label">Minimum wZYS Expected (Slippage Protection)</label>
                                        <input type="number" class="form-control" id="sellMinWZYSOut" placeholder="Minimum wZYS you expect to receive" min="0" step="0.0001" required>
                                        <div class="error-message" id="sellMinWZYSError"></div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> There is a 10% reduction when selling YRS.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <span class="btn-text">Sell YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                </form>
                            </div>
                            <!-- Burn Tab -->
                            <div class="tab-pane fade" id="burn" role="tabpanel" aria-labelledby="burn-tab">
                                <form id="burnForm">
                                    <div class="mb-3">
                                        <label for="burnAmount" class="form-label">YRS Amount to Burn</label>
                                        <input type="number" class="form-control" id="burnAmount" placeholder="Amount of YRS to burn" min="0" step="0.0001" required>
                                        <div class="error-message" id="burnAmountError"></div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Burning will permanently remove YRS tokens from circulation. This action cannot be undone.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <span class="btn-text">Burn YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p>&copy; 2023 YRS Staking Platform. All rights reserved.</p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Enhanced contract ABI with error handling
        const contractABI = [
            "function totalWZYSDeposited() view returns (uint256)",
            "function totalYieldReserveShares() view returns (uint256)",
            "function buy1(uint256 wZYSAmount, uint256 minYRSOut)",
            "function sell1(uint256 YRSAmount, uint256 minWZYSOut)",
            "function burn(uint256 amount)",
            "event TokensBought(address indexed buyer, uint256 wZYSAmount, uint256 YRSAmount)",
            "event TokensSold(address indexed seller, uint256 YRSAmount, uint256 wZYSAmount)",
            "event TokensBurned(address indexed burner, uint256 amount)"
        ];

        // Enhanced ERC20 ABI
        const erc20ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function name() view returns (string)",
            "function symbol() view returns (string)"
        ];

        // Contract addresses - replace with actual addresses
        const CONTRACT_ADDRESS = "0x1234567890123456789012345678901234567890"; // Replace with actual contract address
        const WZYS_ADDRESS = "0x1234567890123456789012345678901234567891"; // Replace with actual wZYS token address
        const YRS_ADDRESS = "0x1234567890123456789012345678901234567892"; // Replace with actual YRS token address

        // Global variables
        let provider;
        let signer;
        let contract;
        let wZYSContract;
        let YRSContract;
        let wZYSDecimals = 18;
        let YRSDecimals = 18;
        let isConnected = false;

        // DOM Elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const connectionStatus = document.getElementById('connectionStatus');
        const userBalancesSection = document.getElementById('userBalancesSection');
        const tradeSection = document.getElementById('tradeSection');
        const requirementsSection = document.getElementById('requirementsSection');
        const noWalletAlert = document.getElementById('noWalletAlert');
        const totalWZYSDisplay = document.getElementById('totalWZYS');
        const totalYRSDisplay = document.getElementById('totalYRS');
        const ratioDisplay = document.getElementById('ratio');
        const userWZYSBalance = document.getElementById('userWZYSBalance');
        const userYRSBalance = document.getElementById('userYRSBalance');
        const buyForm = document.getElementById('buyForm');
        const sellForm = document.getElementById('sellForm');
        const burnForm = document.getElementById('burnForm');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkEthereumAvailability();
            setupEventListeners();
        });

        // Check if Ethereum is available
        function checkEthereumAvailability() {
            if (typeof window.ethereum === 'undefined') {
                noWalletAlert.classList.remove('d-none');
                connectWalletBtn.disabled = true;
                connectWalletBtn.innerHTML = '<i class="bi bi-x-circle"></i> No Web3 Wallet';
            } else {
                // Check if we're already connected
                checkExistingConnection();
            }
        }

        // Check for existing connection
        async function checkExistingConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    // We have a connected account, initialize the connection
                    initializeConnection();
                }
            } catch (error) {
                console.error('Error checking existing connection:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Listen for account changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
            }
        }

        // Handle accounts changed
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // User disconnected their wallet
                disconnectWallet();
            } else {
                // Account changed, reinitialize
                initializeConnection();
            }
        }

        // Handle chain changed
        function handleChainChanged(chainId) {
            // Reload the page when network changes
            window.location.reload();
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showToast('Web3 wallet not detected. Please install MetaMask.', 'danger');
                return;
            }

            try {
                connectWalletBtn.classList.add('loading');
                
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Initialize the connection
                await initializeConnection();
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                
                if (error.code === 4001) {
                    // User rejected the request
                    showToast('Connection rejected. Please connect your wallet to use this dApp.', 'warning');
                } else {
                    showToast('Failed to connect wallet: ' + error.message, 'danger');
                }
            } finally {
                connectWalletBtn.classList.remove('loading');
            }
        }

        // Initialize connection after wallet is connected
        async function initializeConnection() {
            try {
                // Create provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                // Initialize contracts
                contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
                wZYSContract = new ethers.Contract(WZYS_ADDRESS, erc20ABI, signer);
                YRSContract = new ethers.Contract(YRS_ADDRESS, erc20ABI, signer);
                
                // Get token decimals with fallback
                try {
                    wZYSDecimals = await wZYSContract.decimals();
                } catch (e) {
                    console.warn('Could not get wZYS decimals, using default 18');
                    wZYSDecimals = 18;
                }
                
                try {
                    YRSDecimals = await YRSContract.decimals();
                } catch (e) {
                    console.warn('Could not get YRS decimals, using default 18');
                    YRSDecimals = 18;
                }
                
                // Update UI
                const address = await signer.getAddress();
                walletAddress.textContent = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                
                connectWalletBtn.classList.add('d-none');
                walletInfo.classList.remove('d-none');
                connectionStatus.classList.remove('d-none', 'status-disconnected');
                connectionStatus.classList.add('status-connected');
                connectionStatus.innerHTML = '<i class="bi bi-dot"></i> Connected';
                
                requirementsSection.style.display = 'none';
                userBalancesSection.style.display = 'block';
                tradeSection.style.display = 'block';
                
                isConnected = true;
                
                // Load initial data
                await loadContractData();
                await loadUserBalances();
                
                showToast('Wallet connected successfully!', 'success');
                
            } catch (error) {
                console.error('Error initializing connection:', error);
                showToast('Failed to initialize connection: ' + error.message, 'danger');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            isConnected = false;
            
            connectWalletBtn.classList.remove('d-none', 'loading');
            walletInfo.classList.add('d-none');
            connectionStatus.classList.remove('status-connected');
            connectionStatus.classList.add('status-disconnected');
            connectionStatus.innerHTML = '<i class="bi bi-dot"></i> Disconnected';
            
            requirementsSection.style.display = 'block';
            userBalancesSection.style.display = 'none';
            tradeSection.style.display = 'none';
            
            connectWalletBtn.innerHTML = '<i class="bi bi-wallet2"></i> Connect Wallet';
            
            showToast('Wallet disconnected.', 'info');
        }

        // Load contract data
        async function loadContractData() {
            if (!isConnected) return;
            
            try {
                const totalWZYS = await contract.totalWZYSDeposited();
                const totalYRS = await contract.totalYieldReserveShares();
                
                const formattedWZYS = ethers.utils.formatUnits(totalWZYS, wZYSDecimals);
                const formattedYRS = ethers.utils.formatUnits(totalYRS, YRSDecimals);
                
                totalWZYSDisplay.textContent = parseFloat(formattedWZYS).toFixed(4);
                totalYRSDisplay.textContent = parseFloat(formattedYRS).toFixed(4);
                
                // Calculate ratio
                const ratio = totalYRS.gt(0) ? totalWZYS.mul(ethers.BigNumber.from(10).pow(18)).div(totalYRS) : ethers.BigNumber.from(0);
                const formattedRatio = ethers.utils.formatUnits(ratio, 18);
                ratioDisplay.textContent = parseFloat(formattedRatio).toFixed(6);
            } catch (error) {
                console.error('Error loading contract data:', error);
                showToast('Failed to load contract data.', 'danger');
            }
        }

        // Load user balances
        async function loadUserBalances() {
            if (!isConnected) return;
            
            try {
                const userAddress = await signer.getAddress();
                const wZYSBalance = await wZYSContract.balanceOf(userAddress);
                const YRSBalance = await YRSContract.balanceOf(userAddress);
                
                const formattedWZYS = ethers.utils.formatUnits(wZYSBalance, wZYSDecimals);
                const formattedYRS = ethers.utils.formatUnits(YRSBalance, YRSDecimals);
                
                userWZYSBalance.textContent = parseFloat(formattedWZYS).toFixed(4);
                userYRSBalance.textContent = parseFloat(formattedYRS).toFixed(4);
            } catch (error) {
                console.error('Error loading user balances:', error);
                showToast('Failed to load user balances.', 'danger');
            }
        }

        // Buy form submission
        buyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isConnected) {
                showToast('Please connect your wallet first.', 'warning');
                return;
            }
            
            const wZYSAmount = document.getElementById('buyWZYSAmount').value;
            const minYRSOut = document.getElementById('buyMinYRSOut').value;
            
            if (!wZYSAmount || !minYRSOut) {
                showToast('Please fill in all fields.', 'warning');
                return;
            }
            
            try {
                // Show loading state
                buyForm.classList.add('loading');
                
                // Convert to wei
                const wZYSAmountWei = ethers.utils.parseUnits(wZYSAmount, wZYSDecimals);
                const minYRSOutWei = ethers.utils.parseUnits(minYRSOut, YRSDecimals);
                
                // Check allowance
                const userAddress = await signer.getAddress();
                const allowance = await wZYSContract.allowance(userAddress, CONTRACT_ADDRESS);
                
                if (allowance.lt(wZYSAmountWei)) {
                    // Approve first
                    showToast('Approving tokens...', 'info');
                    const approveTx = await wZYSContract.approve(CONTRACT_ADDRESS, wZYSAmountWei);
                    await approveTx.wait();
                    showToast('Approval successful. Proceeding with purchase...', 'info');
                }
                
                // Execute buy
                const tx = await contract.buy1(wZYSAmountWei, minYRSOutWei);
                showToast('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();
                
                // Reset form
                buyForm.reset();
                
                // Refresh data
                await loadContractData();
                await loadUserBalances();
                
                showToast('Purchase successful!', 'success');
            } catch (error) {
                console.error('Error buying tokens:', error);
                showToast(`Purchase failed: ${error.message}`, 'danger');
            } finally {
                // Hide loading state
                buyForm.classList.remove('loading');
            }
        });

        // Sell form submission
        sellForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isConnected) {
                showToast('Please connect your wallet first.', 'warning');
                return;
            }
            
            const YRSAmount = document.getElementById('sellYRSAmount').value;
            const minWZYSOut = document.getElementById('sellMinWZYSOut').value;
            
            if (!YRSAmount || !minWZYSOut) {
                showToast('Please fill in all fields.', 'warning');
                return;
            }
            
            try {
                // Show loading state
                sellForm.classList.add('loading');
                
                // Convert to wei
                const YRSAmountWei = ethers.utils.parseUnits(YRSAmount, YRSDecimals);
                const minWZYSOutWei = ethers.utils.parseUnits(minWZYSOut, wZYSDecimals);
                
                // Check allowance
                const userAddress = await signer.getAddress();
                const allowance = await YRSContract.allowance(userAddress, CONTRACT_ADDRESS);
                
                if (allowance.lt(YRSAmountWei)) {
                    // Approve first
                    showToast('Approving tokens...', 'info');
                    const approveTx = await YRSContract.approve(CONTRACT_ADDRESS, YRSAmountWei);
                    await approveTx.wait();
                    showToast('Approval successful. Proceeding with sale...', 'info');
                }
                
                // Execute sell
                const tx = await contract.sell1(YRSAmountWei, minWZYSOutWei);
                showToast('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();
                
                // Reset form
                sellForm.reset();
                
                // Refresh data
                await loadContractData();
                await loadUserBalances();
                
                showToast('Sale successful!', 'success');
            } catch (error) {
                console.error('Error selling tokens:', error);
                showToast(`Sale failed: ${error.message}`, 'danger');
            } finally {
                // Hide loading state
                sellForm.classList.remove('loading');
            }
        });

        // Burn form submission
        burnForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isConnected) {
                showToast('Please connect your wallet first.', 'warning');
                return;
            }
            
            const burnAmount = document.getElementById('burnAmount').value;
            
            if (!burnAmount) {
                showToast('Please fill in all fields.', 'warning');
                return;
            }
            
            try {
                // Show loading state
                burnForm.classList.add('loading');
                
                // Convert to wei
                const burnAmountWei = ethers.utils.parseUnits(burnAmount, YRSDecimals);
                
                // Check allowance
                const userAddress = await signer.getAddress();
                const allowance = await YRSContract.allowance(userAddress, CONTRACT_ADDRESS);
                
                if (allowance.lt(burnAmountWei)) {
                    // Approve first
                    showToast('Approving tokens...', 'info');
                    const approveTx = await YRSContract.approve(CONTRACT_ADDRESS, burnAmountWei);
                    await approveTx.wait();
                    showToast('Approval successful. Proceeding with burn...', 'info');
                }
                
                // Execute burn
                const tx = await contract.burn(burnAmountWei);
                showToast('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();
                
                // Reset form
                burnForm.reset();
                
                // Refresh data
                await loadContractData();
                await loadUserBalances();
                
                showToast('Burn successful!', 'success');
            } catch (error) {
                console.error('Error burning tokens:', error);
                showToast(`Burn failed: ${error.message}`, 'danger');
            } finally {
                // Hide loading state
                burnForm.classList.remove('loading');
            }
        });

        // Show toast notification
        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast custom-toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Auto-refresh data every 30 seconds if connected
        setInterval(async () => {
            if (isConnected) {
                await loadContractData();
                await loadUserBalances();
            }
        }, 30000);
    </script>
</body>
</html>
