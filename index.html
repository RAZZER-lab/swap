<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YRS Staking DApp</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ethers.js library for blockchain interaction -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <style>
        .card { margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-connected { color: #198754; font-weight: bold; }
        .status-disconnected { color: #dc3545; font-weight: bold; }
        .function-section { border-left: 4px solid #0d6efd; padding-left: 1rem; margin-bottom: 2rem; }
        .wallet-info { background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="text-center mb-4">YRS Staking Interface</h1>
        
        <!-- Connection Status and Wallet Info -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Wallet Connection</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p>Connection Status: <span id="connectionStatus" class="status-disconnected">Not Connected</span></p>
                        <button id="connectButton" class="btn btn-primary">Connect MetaMask</button>
                    </div>
                    <div class="col-md-6">
                        <div id="walletInfo" style="display: none;">
                            <p>Connected Address: <strong id="connectedAddress"></strong></p>
                            <p>Network: <strong id="networkInfo"></strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Balances -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Token Balances</h5>
                <button id="refreshBalances" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p>wZYS Balance: <strong id="wZYSBalance">0</strong></p>
                    </div>
                    <div class="col-md-4">
                        <p>YRS Balance: <strong id="YRSBalance">0</strong></p>
                    </div>
                    <div class="col-md-4">
                        <p>Contract YRS Reserve: <strong id="contractYRSBalance">0</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Interaction Sections -->
        
        <!-- Buy YRS Tokens -->
        <div class="function-section">
            <h3>Buy YRS Tokens (10% Bonus)</h3>
            <p class="text-muted">Exchange your wZYS for YRS tokens and receive a 10% bonus.</p>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="buyWZYSAmount" class="form-label">wZYS Amount to Spend</label>
                        <input type="number" class="form-control" id="buyWZYSAmount" placeholder="Enter wZYS amount">
                    </div>
                    <div class="mb-3">
                        <label for="minYRSOut" class="form-label">Minimum YRS to Receive (Slippage Protection)</label>
                        <input type="number" class="form-control" id="minYRSOut" placeholder="Enter minimum YRS expected">
                    </div>
                    <button id="buyButton" class="btn btn-success">Buy YRS</button>
                    <div id="buyOutput" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Sell YRS Tokens -->
        <div class="function-section">
            <h3>Sell YRS Tokens (10% Penalty)</h3>
            <p class="text-muted">Exchange your YRS tokens back to wZYS with a 10% reduction.</p>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="sellYRSAmount" class="form-label">YRS Amount to Sell</label>
                        <input type="number" class="form-control" id="sellYRSAmount" placeholder="Enter YRS amount">
                    </div>
                    <div class="mb-3">
                        <label for="minWZYSOut" class="form-label">Minimum wZYS to Receive (Slippage Protection)</label>
                        <input type="number" class="form-control" id="minWZYSOut" placeholder="Enter minimum wZYS expected">
                    </div>
                    <button id="sellButton" class="btn btn-warning">Sell YRS</button>
                    <div id="sellOutput" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Burn YRS Tokens -->
        <div class="function-section">
            <h3>Burn YRS Tokens</h3>
            <p class="text-muted">Permanently remove YRS tokens from circulation.</p>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="burnAmount" class="form-label">YRS Amount to Burn</label>
                        <input type="number" class="form-control" id="burnAmount" placeholder="Enter YRS amount to burn">
                    </div>
                    <button id="burnButton" class="btn btn-danger">Burn YRS</button>
                    <div id="burnOutput" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Admin Functions (Only for Contract Owner) -->
        <div class="function-section">
            <h3>Admin Functions</h3>
            <p class="text-muted">These functions are only available to the contract owner.</p>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="recoverTokenAddress" class="form-label">Token Address to Recover</label>
                        <input type="text" class="form-control" id="recoverTokenAddress" placeholder="Enter token address">
                    </div>
                    <div class="mb-3">
                        <label for="recoverAmount" class="form-label">Amount to Recover</label>
                        <input type="number" class="form-control" id="recoverAmount" placeholder="Enter amount to recover">
                    </div>
                    <button id="recoverButton" class="btn btn-info">Recover ERC20 Tokens</button>
                    <div id="recoverOutput" class="mt-2"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =============================================
        // Configuration and Contract Setup
        // =============================================
        
        // Contract address and ABI
        const contractAddress = '0x0eba64eA7d1055Cb87654EC554360741C31650E6';
        
        // Proper ABI for the YRSStaking contract (inferred from function signatures)
        const contractABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "wZYSAmount", "type": "uint256"},
                    {"internalType": "uint256", "name": "minYRSOut", "type": "uint256"}
                ],
                "name": "buy1",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "YRSAmount", "type": "uint256"},
                    {"internalType": "uint256", "name": "minWZYSOut", "type": "uint256"}
                ],
                "name": "sell1",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "burn",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "tokenAddress", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "recoverERC20",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalYieldReserveShares",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalWZYSDeposited",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "wZYS",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "YRS",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "BONUS_PERCENT",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "PENALTY_PERCENT",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Standard ERC20 ABI for token interactions
        const erc20ABI = [
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function"
            }
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;
        let wZYSToken;
        let YRSToken;

        // =============================================
        // DOM Content Loaded Event Listener
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use this dApp!');
                return;
            }

            // Initialize the provider
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            // Initialize contract object (read-only until signer is connected)
            try {
                contract = new ethers.Contract(contractAddress, contractABI, provider);
            } catch (error) {
                console.error('Error initializing contract:', error);
                alert('Error initializing contract. Please check the console for details.');
                return;
            }

            // Set up event listeners
            document.getElementById('connectButton').addEventListener('click', connectWallet);
            document.getElementById('buyButton').addEventListener('click', buyYRS);
            document.getElementById('sellButton').addEventListener('click', sellYRS);
            document.getElementById('burnButton').addEventListener('click', burnYRS);
            document.getElementById('recoverButton').addEventListener('click', recoverTokens);
            document.getElementById('refreshBalances').addEventListener('click', refreshAllBalances);

            // Listen for account changes
            window.ethereum.on('accountsChanged', function(accounts) {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    userAddress = accounts[0];
                    updateWalletInfo();
                    refreshAllBalances();
                }
            });

            // Listen for chain changes
            window.ethereum.on('chainChanged', function(chainId) {
                window.location.reload();
            });
        });

        // =============================================
        // Wallet Connection Functions
        // =============================================
        
        async function connectWallet() {
            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Get the signer
                signer = provider.getSigner();
                userAddress = accounts[0];
                
                // Update contract instance with signer for write operations
                contract = contract.connect(signer);
                
                // Initialize token contracts
                await initializeTokenContracts();
                
                // Update UI
                updateWalletInfo();
                await refreshAllBalances();
                
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'status-connected';
                
            } catch (error) {
                console.error('Error connecting to wallet:', error);
                alert('Error connecting to MetaMask: ' + error.message);
            }
        }

        function disconnectWallet() {
            userAddress = null;
            signer = null;
            contract = new ethers.Contract(contractAddress, contractABI, provider);
            
            document.getElementById('connectionStatus').textContent = 'Not Connected';
            document.getElementById('connectionStatus').className = 'status-disconnected';
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('connectedAddress').textContent = '';
            document.getElementById('networkInfo').textContent = '';
            
            // Reset balances
            document.getElementById('wZYSBalance').textContent = '0';
            document.getElementById('YRSBalance').textContent = '0';
            document.getElementById('contractYRSBalance').textContent = '0';
        }

        async function updateWalletInfo() {
            if (userAddress) {
                const network = await provider.getNetwork();
                document.getElementById('connectedAddress').textContent = userAddress;
                document.getElementById('networkInfo').textContent = `${network.name} (Chain ID: ${network.chainId})`;
                document.getElementById('walletInfo').style.display = 'block';
            }
        }

        // =============================================
        // Token and Balance Functions
        // =============================================
        
        async function initializeTokenContracts() {
            try {
                // Get token addresses from the main contract
                const wZYSAddress = await contract.wZYS();
                const YRSAddress = await contract.YRS();
                
                // Create contract instances for the tokens
                wZYSToken = new ethers.Contract(wZYSAddress, erc20ABI, provider);
                YRSToken = new ethers.Contract(YRSAddress, erc20ABI, provider);
                
                // If we have a signer, use it for write operations
                if (signer) {
                    wZYSToken = wZYSToken.connect(signer);
                    YRSToken = YRSToken.connect(signer);
                }
            } catch (error) {
                console.error('Error initializing token contracts:', error);
                throw error; // Re-throw to handle in caller
            }
        }

        async function refreshAllBalances() {
            if (!userAddress) return;
            
            try {
                // Get user's wZYS balance
                const wZYSBalance = await wZYSToken.balanceOf(userAddress);
                document.getElementById('wZYSBalance').textContent = ethers.utils.formatUnits(wZYSBalance, 18);
                
                // Get user's YRS balance
                const YRSBalance = await YRSToken.balanceOf(userAddress);
                document.getElementById('YRSBalance').textContent = ethers.utils.formatUnits(YRSBalance, 18);
                
                // Get contract's YRS balance
                const YRSAddress = await contract.YRS();
                const YRSTokenContract = new ethers.Contract(YRSAddress, erc20ABI, provider);
                const contractBalance = await YRSTokenContract.balanceOf(contractAddress);
                document.getElementById('contractYRSBalance').textContent = ethers.utils.formatUnits(contractBalance, 18);
                
            } catch (error) {
                console.error('Error refreshing balances:', error);
            }
        }

        // =============================================
        // Contract Interaction Functions
        // =============================================
        
        async function buyYRS() {
            if (!userAddress) {
                alert('Please connect your wallet first!');
                return;
            }
            
            const wZYSAmount = document.getElementById('buyWZYSAmount').value;
            const minYRSOut = document.getElementById('minYRSOut').value;
            
            if (!wZYSAmount || !minYRSOut) {
                alert('Please fill in all fields!');
                return;
            }
            
            try {
                // First, approve the contract to spend wZYS tokens
                const wZYSAddress = await contract.wZYS();
                const wZYSTokenWithSigner = new ethers.Contract(wZYSAddress, erc20ABI, signer);
                
                const approveTx = await wZYSTokenWithSigner.approve(
                    contractAddress, 
                    ethers.utils.parseUnits(wZYSAmount, 18)
                );
                
                document.getElementById('buyOutput').innerHTML = '<div class="alert alert-info">Approving wZYS tokens... Waiting for transaction confirmation.</div>';
                await approveTx.wait();
                
                // Now execute the buy transaction
                const buyTx = await contract.buy1(
                    ethers.utils.parseUnits(wZYSAmount, 18),
                    ethers.utils.parseUnits(minYRSOut, 18)
                );
                
                document.getElementById('buyOutput').innerHTML = '<div class="alert alert-info">Buy transaction submitted! Waiting for confirmation...</div>';
                await buyTx.wait();
                
                document.getElementById('buyOutput').innerHTML = '<div class="alert alert-success">Successfully bought YRS tokens!</div>';
                
                // Refresh balances
                refreshAllBalances();
                
            } catch (error) {
                console.error('Error buying YRS:', error);
                document.getElementById('buyOutput').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function sellYRS() {
            if (!userAddress) {
                alert('Please connect your wallet first!');
                return;
            }
            
            const YRSAmount = document.getElementById('sellYRSAmount').value;
            const minWZYSOut = document.getElementById('minWZYSOut').value;
            
            if (!YRSAmount || !minWZYSOut) {
                alert('Please fill in all fields!');
                return;
            }
            
            try {
                // First, approve the contract to spend YRS tokens
                const YRSAddress = await contract.YRS();
                const YRSTokenWithSigner = new ethers.Contract(YRSAddress, erc20ABI, signer);
                
                const approveTx = await YRSTokenWithSigner.approve(
                    contractAddress, 
                    ethers.utils.parseUnits(YRSAmount, 18)
                );
                
                document.getElementById('sellOutput').innerHTML = '<div class="alert alert-info">Approving YRS tokens... Waiting for transaction confirmation.</div>';
                await approveTx.wait();
                
                // Now execute the sell transaction
                const sellTx = await contract.sell1(
                    ethers.utils.parseUnits(YRSAmount, 18),
                    ethers.utils.parseUnits(minWZYSOut, 18)
                );
                
                document.getElementById('sellOutput').innerHTML = '<div class="alert alert-info">Sell transaction submitted! Waiting for confirmation...</div>';
                await sellTx.wait();
                
                document.getElementById('sellOutput').innerHTML = '<div class="alert alert-success">Successfully sold YRS tokens!</div>';
                
                // Refresh balances
                refreshAllBalances();
                
            } catch (error) {
                console.error('Error selling YRS:', error);
                document.getElementById('sellOutput').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function burnYRS() {
            if (!userAddress) {
                alert('Please connect your wallet first!');
                return;
            }
            
            const burnAmount = document.getElementById('burnAmount').value;
            
            if (!burnAmount) {
                alert('Please enter an amount to burn!');
                return;
            }
            
            try {
                // First, approve the contract to spend YRS tokens
                const YRSAddress = await contract.YRS();
                const YRSTokenWithSigner = new ethers.Contract(YRSAddress, erc20ABI, signer);
                
                const approveTx = await YRSTokenWithSigner.approve(
                    contractAddress, 
                    ethers.utils.parseUnits(burnAmount, 18)
                );
                
                document.getElementById('burnOutput').innerHTML = '<div class="alert alert-info">Approving YRS tokens for burning... Waiting for transaction confirmation.</div>';
                await approveTx.wait();
                
                // Now execute the burn transaction
                const burnTx = await contract.burn(ethers.utils.parseUnits(burnAmount, 18));
                
                document.getElementById('burnOutput').innerHTML = '<div class="alert alert-info">Burn transaction submitted! Waiting for confirmation...</div>';
                await burnTx.wait();
                
                document.getElementById('burnOutput').innerHTML = '<div class="alert alert-success">Successfully burned YRS tokens!</div>';
                
                // Refresh balances
                refreshAllBalances();
                
            } catch (error) {
                console.error('Error burning YRS:', error);
                document.getElementById('burnOutput').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function recoverTokens() {
            if (!userAddress) {
                alert('Please connect your wallet first!');
                return;
            }
            
            const tokenAddress = document.getElementById('recoverTokenAddress').value;
            const amount = document.getElementById('recoverAmount').value;
            
            if (!tokenAddress || !amount) {
                alert('Please fill in all fields!');
                return;
            }
            
            // Basic address validation
            if (!ethers.utils.isAddress(tokenAddress)) {
                alert('Please enter a valid token address!');
                return;
            }
            
            try {
                const recoverTx = await contract.recoverERC20(
                    tokenAddress,
                    ethers.utils.parseUnits(amount, 18)
                );
                
                document.getElementById('recoverOutput').innerHTML = '<div class="alert alert-info">Recovery transaction submitted! Waiting for confirmation...</div>';
                await recoverTx.wait();
                
                document.getElementById('recoverOutput').innerHTML = '<div class="alert alert-success">Successfully recovered tokens!</div>';
                
            } catch (error) {
                console.error('Error recovering tokens:', error);
                document.getElementById('recoverOutput').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
