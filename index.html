<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ZEPHYR SWAP // NILE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: monospace;
    }
    .container {
      max-width: 45%;
      margin: 0 auto;
      padding: 2rem;
      margin-top: -1rem;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      letter-spacing: 2px;
      margin-left: 2rem;
      border-bottom: 1px dashed #666;
      padding-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .section {
      margin: auto;
      direction: rtl;
    }
    button, input {
      font-family: monospace;
      font-size: 1rem;
      padding: 0.75rem 1rem;
      margin-top: 0.5rem;
      background: #000;
      color: #fff;
      border: 1px solid #fff;
      width: 100%;
      transition: 0.3s;
      direction: rtl;
    }
    input {
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #fff;
      color: #000;
      cursor: pointer;
    }
    .status {
      margin-top: 2rem;
      white-space: pre-line;
      padding-top: 1rem;
      color: #0f0;
      font-size: 0.9rem;
    }
    .error { color: #f33; font-weight: bold; }
    .success { color: #0f0; font-weight: bold; }
    .link {
      color: #0ff;
      text-decoration: underline;
    }
    .balance {
      font-size: 1rem;
      margin-top: 0.3rem;
      color: #ccc;
    }
    svg {
      background: #f9f9f9;
      margin-top: 38rem;
      margin-left: 23rem;display:none;
    }
    .grid line {
      stroke: #ddd;
    }
    .label {
      font-size: 10px;
      fill: #333;
    }

    .SCbalance {
      direction: ltr;
      margin-top: 1rem;
      border-bottom: 1px dashed #666;
    }
    
    /* Android-specific styles */
    .android-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #0f0;
      padding: 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      max-width: 200px;
    }
  </style>
</head>
<body>
  <div class="android-info">
    <strong>Android WebView Mode</strong>
    <div>Using TronLink via Android bridge</div>
  </div>
  
  <h1>ZYS/USD DEX SWAP</h1>
  <svg id="chart" width="50%" height="500"></svg>
  <div class="container">
    
    <h1>Over-Collateralization (OC) RATE: </h1>
    <div id="SCbalances" class="SCsection">
      <div class="SCbalance">ZSD: <span id="SCzsdBal">--</span></div>
      <div class="SCbalance">ZYS: <span id="SCzysBal">--</span></div>
      <div class="SCbalance">OC RATIO (%): <span id="SCocRATIO">--</span></div>
    </div>

    <h1>ZEPHYR SWAP : ZSD ‚Üí ZYS</h1>
    <div class="section">
      <button id="connectBtn">[ CONNECT WALLET ]</button>
      <div id="walletAddress" class="balance"></div>
    </div>

    <div id="balances" class="section" style="display:none;">
      <div class="balance">TRX: <span id="trxBal">--</span></div>
      <div class="balance">ZSD: <span id="zsdBal">--</span></div>
      <div class="balance">ZYS: <span id="zysBal">--</span></div>
    </div>

    <div class="section" id="swapSection" style="display:none;">
      <input type="number" id="amountInput" placeholder="Enter amount of ZSD to swap">
      <button id="swapBtn">[ EXECUTE SWAP ]</button>
    </div>

    <div id="status" class="status"></div>
  </div>

 <script>
// ======================
// TronLink Bridge Handler
// ======================
window.handleTronLinkCallback = function(callbackUrl) {
  console.log("Received TronLink callback:", callbackUrl);
  try {
    const url = new URL(callbackUrl);
    const params = new URLSearchParams(url.search);
    
    if (params.has('address')) {
      handleWalletConnected(params.get('address'));
    } 
    else if (params.has('signedTransaction')) {
      log("‚úÖ Transaction signed", "success");
      // Continue with broadcast logic if needed
    }
    else if (params.has('txId')) {
      handleTransactionSuccess(params.get('txId'));
    }
    else {
      log("Unknown callback: " + callbackUrl, "error");
    }
  } catch (e) {
    log("‚ùå Error processing callback: " + e.message, "error");
  }
};

function handleWalletConnected(address) {
  log("‚úÖ Wallet connected", "success");
  userAddress = address;
  walletDisplay.textContent = `Connected: ${address}`;
  balances.style.display = 'block';
  swapSection.style.display = 'block';
  
  // Update UI immediately
  updateWalletDisplay();
  
  // Load real balances if available
  if (window.tronWeb) {
    updateBalances();
  }
}

function updateWalletDisplay() {
  walletDisplay.textContent = `Connected: ${userAddress}`;
  walletDisplay.style.display = "block";
  connectBtn.textContent = "[ DISCONNECT ]";
}

// ======================
// Wallet Connection Flow
// ======================
async function connectWallet() {
  statusBox.innerHTML = '';
  
  if (userAddress) {
    // Disconnect if already connected
    userAddress = null;
    walletDisplay.style.display = "none";
    balances.style.display = "none";
    swapSection.style.display = "none";
    connectBtn.textContent = "[ CONNECT WALLET ]";
    return;
  }
  
  if (isAndroidWebView()) {
    log("üîÑ Connecting via Android bridge...");
    try {
      // First check if bridge is available
      if (window.TronLinkAndroid && window.TronLinkAndroid.connectWallet) {
        window.TronLinkAndroid.connectWallet();
      } else {
        throw new Error("Android bridge not available");
      }
    } catch (e) {
      log("‚ùå Connection failed: " + e.message, "error");
    }
    return;
  }
  
  // Browser TronLink fallback
  if (!window.tronWeb || !window.tronWeb.ready) {
    log("‚ùå TronLink not detected", "error");
    log("Install TronLink extension or use mobile app", "error");
    return;
  }
  
  try {
    await window.tronWeb.request({ method: 'tron_requestAccounts' });
    userAddress = window.tronWeb.defaultAddress.base58;
    updateWalletDisplay();
    updateBalances();
  } catch (e) {
    log("‚ùå Connection rejected: " + e.message, "error");
  }
}

// ======================
// Swap Execution
// ======================
async function executeSwap() {
  if (!userAddress) {
    log("‚ùå Connect wallet first", "error");
    return;
  }
  
  const amount = parseFloat(amountInput.value);
  if (isNaN(amount) || amount <= 0) {
    log("‚ùå Invalid amount", "error");
    return;
  }

  if (isAndroidWebView()) {
    log("üîÑ Requesting swap via Android...");
    try {
      const rawTx = JSON.stringify({
        contractAddress: DEX,
        functionSelector: "swapAForB(uint256)",
        parameter: toHex(amount * 10 ** DECIMALS),
        feeLimit: 100000000
      });
      
      if (window.TronLinkAndroid && window.TronLinkAndroid.signTransaction) {
        window.TronLinkAndroid.signTransaction(rawTx);
      } else {
        throw new Error("Android bridge not available");
      }
    } catch (e) {
      log("‚ùå Swap initiation failed: " + e.message, "error");
    }
    return;
  }
  
  // Browser implementation
  try {
    // ... existing swap code ...
  } catch (err) {
    log("‚ùå Swap failed: " + err.message, "error");
  }
}

// Helper function for Android parameter conversion
function toHex(value) {
  const bigIntValue = BigInt(value);
  return bigIntValue.toString(16).padStart(64, '0');
}

// ======================
// Initialization
// ======================
let userAddress = null;

window.addEventListener("load", () => {
  // Check for wallet connection persistence
  const savedAddress = localStorage.getItem('tronAddress');
  if (savedAddress) {
    userAddress = savedAddress;
    updateWalletDisplay();
    
    // Load balances if possible
    if (window.tronWeb) {
      updateBalances();
    }
  }
  
  if (isAndroidWebView()) {
    log("üì± Android mode: Ready for TronLink");
  } else if (window.tronWeb) {
    log("üåê TronLink detected: Click CONNECT");
  } else {
    log("‚ÑπÔ∏è Install TronLink for full functionality");
  }
});
</script>
</body>
</html>
