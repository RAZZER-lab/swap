<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YRS Staking Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: #3a5bd9;
            border-color: #3a5bd9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        
        .wallet-address {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .ratio-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .token-balance {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.7rem;
            border: 1px solid #ddd;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 108, 247, 0.25);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
        }
        
        .loading-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .loading .loading-spinner {
            display: inline-block;
        }
        
        .loading .btn-text {
            display: none;
        }
        
        .tab-content {
            padding-top: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .stats-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .error-message {
            color: var(--danger-color);
            margin-top: 0.5rem;
            display: none;
        }
        
        .network-info {
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .config-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-connected {
            background-color: var(--success-color);
        }
        
        .status-disconnected {
            background-color: var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-currency-bitcoin"></i> YRS Staking Platform
            </a>
            <div class="d-flex align-items-center">
                <div id="networkInfo" class="me-3 d-none">
                    <span class="network-info">
                        <span id="networkStatus" class="status-indicator status-disconnected"></span>
                        <span id="networkName">Unknown Network</span>
                    </span>
                </div>
                <div id="walletInfo" class="me-3 d-none">
                    <span class="wallet-address" id="walletAddress"></span>
                </div>
                <button id="connectWalletBtn" class="btn btn-primary">
                    <i class="bi bi-wallet2"></i> Connect Wallet
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-4">YRS Staking Platform</h1>
            <p class="lead">Stake your wZYS tokens and earn YRS with bonuses</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mb-5">
        <!-- Configuration Section -->
        <div class="config-section">
            <h5 class="mb-3">Contract Configuration</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="contractAddress" class="form-label">YRSStaking Contract Address</label>
                    <input type="text" class="form-control" id="contractAddress" placeholder="0x..." value="0x1234567890123456789012345678901234567890">
                </div>
                <div class="col-md-4">
                    <label for="wZYSAddress" class="form-label">wZYS Token Address</label>
                    <input type="text" class="form-control" id="wZYSAddress" placeholder="0x..." value="0x1234567890123456789012345678901234567891">
                </div>
                <div class="col-md-4">
                    <label for="YRSAddress" class="form-label">YRS Token Address</label>
                    <input type="text" class="form-control" id="YRSAddress" placeholder="0x..." value="0x1234567890123456789012345678901234567892">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="wZYSDecimals" class="form-label">wZYS Decimals</label>
                    <input type="number" class="form-control" id="wZYSDecimals" value="12" readonly>
                </div>
                <div class="col-md-6">
                    <label for="YRSDecimals" class="form-label">YRS Decimals</label>
                    <input type="number" class="form-control" id="YRSDecimals" value="18" readonly>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button id="updateContractsBtn" class="btn btn-primary">
                        <i class="bi bi-arrow-clockwise"></i> Update Contracts
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">wZYS Deposited</div>
                    <div class="stats-value" id="totalWZYS">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">YRS Reserve Shares</div>
                    <div class="stats-value" id="totalYRS">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-label">wZYS/YRS Ratio</div>
                    <div class="ratio-display" id="ratio">0</div>
                </div>
            </div>
        </div>

        <!-- User Balances Section -->
        <div class="row mb-4" id="userBalancesSection" style="display: none;">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-wallet2"></i> Your wZYS Balance
                    </div>
                    <div class="card-body">
                        <div class="token-balance" id="userWZYSBalance">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-wallet2"></i> Your YRS Balance
                    </div>
                    <div class="card-body">
                        <div class="token-balance" id="userYRSBalance">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buy/Sell Section -->
        <div class="row" id="tradeSection" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-arrow-left-right"></i> Trade Tokens
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="tradeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="buy-tab" data-bs-toggle="tab" data-bs-target="#buy" type="button" role="tab" aria-controls="buy" aria-selected="true">Buy YRS</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sell-tab" data-bs-toggle="tab" data-bs-target="#sell" type="button" role="tab" aria-controls="sell" aria-selected="false">Sell YRS</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="burn-tab" data-bs-toggle="tab" data-bs-target="#burn" type="button" role="tab" aria-controls="burn" aria-selected="false">Burn YRS</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="tradeTabContent">
                            <!-- Buy Tab -->
                            <div class="tab-pane fade show active" id="buy" role="tabpanel" aria-labelledby="buy-tab">
                                <form id="buyForm">
                                    <div class="mb-3">
                                        <label for="buyWZYSAmount" class="form-label">wZYS Amount</label>
                                        <input type="number" class="form-control" id="buyWZYSAmount" placeholder="Amount of wZYS to spend" min="0" step="0.0001" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyMinYRSOut" class="form-label">Minimum YRS Expected (Slippage Protection)</label>
                                        <input type="number" class="form-control" id="buyMinYRSOut" placeholder="Minimum YRS you expect to receive" min="0" step="0.0001" required>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> You will receive a 10% bonus on your purchase.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <span class="btn-text">Buy YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                    <div class="error-message" id="buyError"></div>
                                </form>
                            </div>
                            <!-- Sell Tab -->
                            <div class="tab-pane fade" id="sell" role="tabpanel" aria-labelledby="sell-tab">
                                <form id="sellForm">
                                    <div class="mb-3">
                                        <label for="sellYRSAmount" class="form-label">YRS Amount</label>
                                        <input type="number" class="form-control" id="sellYRSAmount" placeholder="Amount of YRS to sell" min="0" step="0.0001" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sellMinWZYSOut" class="form-label">Minimum wZYS Expected (Slippage Protection)</label>
                                        <input type="number" class="form-control" id="sellMinWZYSOut" placeholder="Minimum wZYS you expect to receive" min="0" step="0.0001" required>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> There is a 10% reduction when selling YRS.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <span class="btn-text">Sell YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                    <div class="error-message" id="sellError"></div>
                                </form>
                            </div>
                            <!-- Burn Tab -->
                            <div class="tab-pane fade" id="burn" role="tabpanel" aria-labelledby="burn-tab">
                                <form id="burnForm">
                                    <div class="mb-3">
                                        <label for="burnAmount" class="form-label">YRS Amount to Burn</label>
                                        <input type="number" class="form-control" id="burnAmount" placeholder="Amount of YRS to burn" min="0" step="0.0001" required>
                                    </div>
                                    <div class="mb-3">
                                        <div class="alert alert-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Burning will permanently remove YRS tokens from circulation. This action cannot be undone.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <span class="btn-text">Burn YRS</span>
                                        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                                    </button>
                                    <div class="error-message" id="burnError"></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p>&copy; 2023 YRS Staking Platform. All rights reserved.</p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Ethers.js - using a more reliable CDN -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <script>
        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                console.error('Ethers.js library failed to load');
                showToast('Failed to load required libraries. Please refresh the page.', 'danger');
                return;
            }

            // Contract ABI - simplified version with only the functions we need
            const contractABI = [
                "function totalWZYSDeposited() view returns (uint256)",
                "function totalYieldReserveShares() view returns (uint256)",
                "function buy1(uint256 wZYSAmount, uint256 minYRSOut)",
                "function sell1(uint256 YRSAmount, uint256 minWZYSOut)",
                "function burn(uint256 amount)",
                "event TokensBought(address indexed buyer, uint256 wZYSAmount, uint256 YRSAmount)",
                "event TokensSold(address indexed seller, uint256 YRSAmount, uint256 wZYSAmount)",
                "event TokensBurned(address indexed burner, uint256 amount)"
            ];

            // ERC20 ABI - simplified version
            const erc20ABI = [
                "function balanceOf(address account) view returns (uint256)",
                "function decimals() view returns (uint8)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function allowance(address owner, address spender) view returns (uint256)",
                "function name() view returns (string)",
                "function symbol() view returns (string)"
            ];

            // Network configurations
            const NETWORKS = {
                1: { name: "Ethereum Mainnet", rpcUrl: "https://mainnet.infura.io/v3/" },
                3: { name: "Ropsten Testnet", rpcUrl: "https://ropsten.infura.io/v3/" },
                4: { name: "Rinkeby Testnet", rpcUrl: "https://rinkeby.infura.io/v3/" },
                5: { name: "Goerli Testnet", rpcUrl: "https://goerli.infura.io/v3/" },
                42: { name: "Kovan Testnet", rpcUrl: "https://kovan.infura.io/v3/" },
                56: { name: "Binance Smart Chain", rpcUrl: "https://bsc-dataseed.binance.org/" },
                97: { name: "BSC Testnet", rpcUrl: "https://data-seed-prebsc-1-s1.binance.org:8545/" },
                137: { name: "Polygon Mainnet", rpcUrl: "https://polygon-rpc.com/" },
                80001: { name: "Mumbai Testnet", rpcUrl: "https://rpc-mumbai.maticvigil.com/" },
                43114: { name: "Avalanche Mainnet", rpcUrl: "https://api.avax.network/ext/bc/C/rpc" },
                43113: { name: "Fuji Testnet", rpcUrl: "https://api.avax-test.network/ext/bc/C/rpc" }
            };

            // Contract addresses - will be updated from the form
            let CONTRACT_ADDRESS = "0x1234567890123456789012345678901234567890";
            let WZYS_ADDRESS = "0x1234567890123456789012345678901234567891";
            let YRS_ADDRESS = "0x1234567890123456789012345678901234567892";
            
            // Token decimals - hardcoded as per user requirements
            const WZYS_DECIMALS = 12;
            const YRS_DECIMALS = 18;

            let provider;
            let signer;
            let contract;
            let wZYSContract;
            let YRSContract;
            let currentNetworkId;

            // DOM Elements
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const updateContractsBtn = document.getElementById('updateContractsBtn');
            const walletInfo = document.getElementById('walletInfo');
            const networkInfo = document.getElementById('networkInfo');
            const networkStatus = document.getElementById('networkStatus');
            const networkName = document.getElementById('networkName');
            const walletAddress = document.getElementById('walletAddress');
            const userBalancesSection = document.getElementById('userBalancesSection');
            const tradeSection = document.getElementById('tradeSection');
            const totalWZYSDisplay = document.getElementById('totalWZYS');
            const totalYRSDisplay = document.getElementById('totalYRS');
            const ratioDisplay = document.getElementById('ratio');
            const userWZYSBalance = document.getElementById('userWZYSBalance');
            const userYRSBalance = document.getElementById('userYRSBalance');
            const buyForm = document.getElementById('buyForm');
            const sellForm = document.getElementById('sellForm');
            const burnForm = document.getElementById('burnForm');
            const buyError = document.getElementById('buyError');
            const sellError = document.getElementById('sellError');
            const burnError = document.getElementById('burnError');
            const contractAddressInput = document.getElementById('contractAddress');
            const wZYSAddressInput = document.getElementById('wZYSAddress');
            const YRSAddressInput = document.getElementById('YRSAddress');
            const wZYSDecimalsInput = document.getElementById('wZYSDecimals');
            const YRSDecimalsInput = document.getElementById('YRSDecimals');

            // Update contracts button
            updateContractsBtn.addEventListener('click', () => {
                CONTRACT_ADDRESS = contractAddressInput.value.trim();
                WZYS_ADDRESS = wZYSAddressInput.value.trim();
                YRS_ADDRESS = YRSAddressInput.value.trim();
                
                if (!CONTRACT_ADDRESS || !WZYS_ADDRESS || !YRS_ADDRESS) {
                    showToast('Please enter valid contract addresses', 'warning');
                    return;
                }
                
                // Reinitialize contracts if wallet is connected
                if (signer) {
                    initializeContracts();
                    showToast('Contract addresses updated successfully', 'success');
                    
                    // Reload data
                    loadContractData();
                    loadUserBalances();
                } else {
                    showToast('Please connect your wallet first', 'warning');
                }
            });

            // Connect to MetaMask
            connectWalletBtn.addEventListener('click', async () => {
                try {
                    // Check if MetaMask is installed
                    if (typeof window.ethereum === 'undefined') {
                        showToast('MetaMask is not installed. Please install it to use this dApp.', 'danger');
                        return;
                    }

                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Create provider and signer
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // Get network information
                    const network = await provider.getNetwork();
                    currentNetworkId = network.chainId;
                    
                    // Update network display
                    updateNetworkDisplay(network);
                    
                    // Initialize contracts
                    initializeContracts();
                    
                    // Update UI
                    const address = await signer.getAddress();
                    walletAddress.textContent = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                    connectWalletBtn.classList.add('d-none');
                    walletInfo.classList.remove('d-none');
                    networkInfo.classList.remove('d-none');
                    userBalancesSection.style.display = 'block';
                    tradeSection.style.display = 'block';
                    
                    // Load initial data
                    await loadContractData();
                    await loadUserBalances();
                    
                    showToast('Wallet connected successfully!', 'success');
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    showToast(`Failed to connect wallet: ${error.message}`, 'danger');
                }
            });

            // Initialize contracts
            function initializeContracts() {
                try {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
                    wZYSContract = new ethers.Contract(WZYS_ADDRESS, erc20ABI, signer);
                    YRSContract = new ethers.Contract(YRS_ADDRESS, erc20ABI, signer);
                    console.log('Contracts initialized successfully');
                } catch (error) {
                    console.error('Error initializing contracts:', error);
                    showToast('Failed to initialize contracts. Please check the addresses.', 'danger');
                }
            }

            // Update network display
            function updateNetworkDisplay(network) {
                const networkId = network.chainId;
                const networkConfig = NETWORKS[networkId];
                
                if (networkConfig) {
                    networkName.textContent = networkConfig.name;
                    networkStatus.classList.remove('status-disconnected');
                    networkStatus.classList.add('status-connected');
                } else {
                    networkName.textContent = `Unknown Network (ID: ${networkId})`;
                    networkStatus.classList.remove('status-connected');
                    networkStatus.classList.add('status-disconnected');
                }
            }

            // Listen for network changes
            if (window.ethereum) {
                window.ethereum.on('chainChanged', (chainId) => {
                    // Reload the page when the network changes
                    window.location.reload();
                });
                
                window.ethereum.on('accountsChanged', (accounts) => {
                    // Reload the page when the account changes
                    if (accounts.length === 0) {
                        window.location.reload();
                    } else {
                        window.location.reload();
                    }
                });
            }

            // Load contract data
            async function loadContractData() {
                try {
                    if (!contract) {
                        console.error('Contract not initialized');
                        return;
                    }
                    
                    const totalWZYS = await contract.totalWZYSDeposited();
                    const totalYRS = await contract.totalYieldReserveShares();
                    
                    const formattedWZYS = ethers.utils.formatUnits(totalWZYS, WZYS_DECIMALS);
                    const formattedYRS = ethers.utils.formatUnits(totalYRS, YRS_DECIMALS);
                    
                    totalWZYSDisplay.textContent = parseFloat(formattedWZYS).toFixed(4);
                    totalYRSDisplay.textContent = parseFloat(formattedYRS).toFixed(4);
                    
                    // Calculate ratio
                    if (totalYRS.gt(0)) {
                        const ratio = totalWZYS.mul(ethers.BigNumber.from(10).pow(18)).div(totalYRS);
                        const formattedRatio = ethers.utils.formatUnits(ratio, 18);
                        ratioDisplay.textContent = parseFloat(formattedRatio).toFixed(6);
                    } else {
                        ratioDisplay.textContent = "0";
                    }
                } catch (error) {
                    console.error('Error loading contract data:', error);
                    showToast('Failed to load contract data. Please check if the contracts are deployed on this network.', 'danger');
                }
            }

            // Load user balances
            async function loadUserBalances() {
                try {
                    if (!wZYSContract || !YRSContract || !signer) {
                        console.error('Contracts or signer not initialized');
                        return;
                    }
                    
                    const userAddress = await signer.getAddress();
                    const wZYSBalance = await wZYSContract.balanceOf(userAddress);
                    const YRSBalance = await YRSContract.balanceOf(userAddress);
                    
                    const formattedWZYS = ethers.utils.formatUnits(wZYSBalance, WZYS_DECIMALS);
                    const formattedYRS = ethers.utils.formatUnits(YRSBalance, YRS_DECIMALS);
                    
                    userWZYSBalance.textContent = parseFloat(formattedWZYS).toFixed(4);
                    userYRSBalance.textContent = parseFloat(formattedYRS).toFixed(4);
                } catch (error) {
                    console.error('Error loading user balances:', error);
                    showToast('Failed to load user balances. Please check if the token contracts are correct.', 'danger');
                }
            }

            // Buy form submission
            buyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideError('buyError');
                
                const wZYSAmount = document.getElementById('buyWZYSAmount').value;
                const minYRSOut = document.getElementById('buyMinYRSOut').value;
                
                if (!wZYSAmount || !minYRSOut) {
                    showError('buyError', 'Please fill in all fields.');
                    return;
                }
                
                try {
                    // Show loading state
                    buyForm.classList.add('loading');
                    
                    // Convert to wei
                    const wZYSAmountWei = ethers.utils.parseUnits(wZYSAmount, WZYS_DECIMALS);
                    const minYRSOutWei = ethers.utils.parseUnits(minYRSOut, YRS_DECIMALS);
                    
                    // Check allowance
                    const userAddress = await signer.getAddress();
                    const allowance = await wZYSContract.allowance(userAddress, CONTRACT_ADDRESS);
                    
                    if (allowance.lt(wZYSAmountWei)) {
                        // Approve first
                        const approveTx = await wZYSContract.approve(CONTRACT_ADDRESS, wZYSAmountWei);
                        await approveTx.wait();
                        showToast('Approval successful. Proceeding with purchase...', 'info');
                    }
                    
                    // Execute buy
                    const tx = await contract.buy1(wZYSAmountWei, minYRSOutWei);
                    await tx.wait();
                    
                    // Reset form
                    buyForm.reset();
                    
                    // Refresh data
                    await loadContractData();
                    await loadUserBalances();
                    
                    showToast('Purchase successful!', 'success');
                } catch (error) {
                    console.error('Error buying tokens:', error);
                    showError('buyError', `Purchase failed: ${error.message}`);
                } finally {
                    // Hide loading state
                    buyForm.classList.remove('loading');
                }
            });

            // Sell form submission
            sellForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideError('sellError');
                
                const YRSAmount = document.getElementById('sellYRSAmount').value;
                const minWZYSOut = document.getElementById('sellMinWZYSOut').value;
                
                if (!YRSAmount || !minWZYSOut) {
                    showError('sellError', 'Please fill in all fields.');
                    return;
                }
                
                try {
                    // Show loading state
                    sellForm.classList.add('loading');
                    
                    // Convert to wei
                    const YRSAmountWei = ethers.utils.parseUnits(YRSAmount, YRS_DECIMALS);
                    const minWZYSOutWei = ethers.utils.parseUnits(minWZYSOut, WZYS_DECIMALS);
                    
                    // Check allowance
                    const userAddress = await signer.getAddress();
                    const allowance = await YRSContract.allowance(userAddress, CONTRACT_ADDRESS);
                    
                    if (allowance.lt(YRSAmountWei)) {
                        // Approve first
                        const approveTx = await YRSContract.approve(CONTRACT_ADDRESS, YRSAmountWei);
                        await approveTx.wait();
                        showToast('Approval successful. Proceeding with sale...', 'info');
                    }
                    
                    // Execute sell
                    const tx = await contract.sell1(YRSAmountWei, minWZYSOutWei);
                    await tx.wait();
                    
                    // Reset form
                    sellForm.reset();
                    
                    // Refresh data
                    await loadContractData();
                    await loadUserBalances();
                    
                    showToast('Sale successful!', 'success');
                } catch (error) {
                    console.error('Error selling tokens:', error);
                    showError('sellError', `Sale failed: ${error.message}`);
                } finally {
                    // Hide loading state
                    sellForm.classList.remove('loading');
                }
            });

            // Burn form submission
            burnForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideError('burnError');
                
                const burnAmount = document.getElementById('burnAmount').value;
                
                if (!burnAmount) {
                    showError('burnError', 'Please fill in all fields.');
                    return;
                }
                
                try {
                    // Show loading state
                    burnForm.classList.add('loading');
                    
                    // Convert to wei
                    const burnAmountWei = ethers.utils.parseUnits(burnAmount, YRS_DECIMALS);
                    
                    // Check allowance
                    const userAddress = await signer.getAddress();
                    const allowance = await YRSContract.allowance(userAddress, CONTRACT_ADDRESS);
                    
                    if (allowance.lt(burnAmountWei)) {
                        // Approve first
                        const approveTx = await YRSContract.approve(CONTRACT_ADDRESS, burnAmountWei);
                        await approveTx.wait();
                        showToast('Approval successful. Proceeding with burn...', 'info');
                    }
                    
                    // Execute burn
                    const tx = await contract.burn(burnAmountWei);
                    await tx.wait();
                    
                    // Reset form
                    burnForm.reset();
                    
                    // Refresh data
                    await loadContractData();
                    await loadUserBalances();
                    
                    showToast('Burn successful!', 'success');
                } catch (error) {
                    console.error('Error burning tokens:', error);
                    showError('burnError', `Burn failed: ${error.message}`);
                } finally {
                    // Hide loading state
                    burnForm.classList.remove('loading');
                }
            });

            // Show error message
            function showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            // Hide error message
            function hideError(elementId) {
                const errorElement = document.getElementById(elementId);
                errorElement.style.display = 'none';
            }

            // Show toast notification
            function showToast(message, type) {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = 'toast-' + Date.now();
                
                const toastHtml = `
                    <div id="${toastId}" class="toast custom-toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();
                
                // Remove toast element after it's hidden
                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }

            // Auto-refresh data every 30 seconds
            setInterval(async () => {
                if (signer) {
                    await loadContractData();
                    await loadUserBalances();
                }
            }, 30000);
        });
    </script>
</body>
</html>
