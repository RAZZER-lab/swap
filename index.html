<script>
    const connectButton = document.getElementById('connectButton');
    const statusDiv = document.getElementById('status');

    // Enhanced check for MetaMask with debugging
    function checkMetaMask() {
        console.log('Current URL:', window.location.href); // Logs if it's file:// or http://
        console.log('window.ethereum:', typeof window.ethereum); // Debug log
        
        if (typeof window.ethereum !== 'undefined') {
            console.log('MetaMask detected!');
            statusDiv.textContent = 'MetaMask ready. Click to connect.';
            connectButton.disabled = false;
            return true;
        } else if (window.location.protocol === 'file:') {
            statusDiv.innerHTML = 'MetaMask blocked on local files in Firefox. <a href="#" onclick="openLocalServerGuide()">Serve via local server</a>.';
            connectButton.disabled = true;
            return false;
        } else {
            statusDiv.textContent = 'MetaMask not detected. Check extension and reload.';
            connectButton.disabled = true;
            return false;
        }
    }

    // Simple guide popup (optional)
    function openLocalServerGuide() {
        alert('Serve via local server:\n1. Save as index.html\n2. Terminal: python -m http.server 8000\n3. Visit http://localhost:8000');
    }

    // Request account access (unchanged)
    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const account = accounts[0];
                    statusDiv.textContent = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                    connectButton.textContent = 'Connected';
                    connectButton.disabled = true;
                    console.log('Connected account:', account);
                }
            } catch (error) {
                console.error('User denied account access:', error);
                statusDiv.textContent = 'Connection rejected.';
            }
        }
    }

    // Event listeners (unchanged)
    connectButton.addEventListener('click', connectWallet);
    checkMetaMask();

    if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length === 0) {
                statusDiv.textContent = 'Disconnected';
                connectButton.textContent = 'Connect to MetaMask';
                connectButton.disabled = false;
            } else {
                const account = accounts[0];
                statusDiv.textContent = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
            }
        });
    }
</script>
